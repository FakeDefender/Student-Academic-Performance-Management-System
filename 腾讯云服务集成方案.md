# 学生成绩查询系统 - 腾讯云服务集成方案

## 1. 腾讯云服务架构概览

本系统采用腾讯云服务构建高可用、可扩展的学生成绩查询系统，充分利用腾讯云的托管服务降低运维复杂度。

## 2. 核心腾讯云服务选择

### 2.1 计算服务
- **腾讯云CVM**: 云服务器
- **腾讯云弹性伸缩**: 自动扩缩容
- **腾讯云负载均衡**: 负载均衡

### 2.2 数据库服务
- **腾讯云MySQL**: 云数据库MySQL
- **腾讯云Redis**: 内存数据库
- **腾讯云对象存储COS**: 文件存储

### 2.3 网络服务
- **腾讯云VPC**: 私有网络
- **腾讯云DNSPod**: DNS服务
- **腾讯云CDN**: 内容分发网络

### 2.4 监控和安全
- **腾讯云监控**: 监控和日志
- **腾讯云访问管理CAM**: 身份和访问管理
- **腾讯云Web应用防火墙**: 安全防护

## 3. 详细架构设计

### 3.1 网络架构

```
Internet
    │
    ▼
腾讯云DNSPod (DNS)
    │
    ▼
腾讯云CDN (内容分发)
    │
    ▼
腾讯云负载均衡CLB
    │
    ├── CVM实例1 (前端)
    ├── CVM实例2 (后端)
    └── CVM实例3 (后端)
    │
    ▼
腾讯云VPC (私有网络)
    │
    ├── 腾讯云MySQL (主从)
    ├── 腾讯云Redis
    └── 腾讯云COS
```

### 3.2 服务配置详情

#### 3.2.1 CVM实例配置

**前端服务器 (Frontend)**
```yaml
实例规格: S5.MEDIUM4
vCPU: 2核
内存: 4GB
存储: 50GB 高性能云硬盘
操作系统: CentOS 7.6
软件: Nginx + React App
```

**后端服务器 (Backend)**
```yaml
实例规格: S5.LARGE8
vCPU: 4核
内存: 8GB
存储: 100GB 高性能云硬盘
操作系统: CentOS 7.6
软件: Java 17 + Spring Boot
```

#### 3.2.2 腾讯云MySQL配置

```yaml
引擎版本: MySQL 8.0
实例规格: 1核2GB
存储: 100GB 高性能云硬盘
备份保留: 7天
加密: 启用
高可用: 主从架构
```

#### 3.2.3 腾讯云Redis配置

```yaml
引擎版本: Redis 6.0
实例规格: 1GB
网络类型: VPC
高可用: 主从架构
```

## 4. 腾讯云服务集成实现

### 4.1 腾讯云MySQL集成

#### 4.1.1 数据库连接配置

**Spring Boot配置 (application-prod.yml)**
```yaml
spring:
  datasource:
    url: jdbc:mysql://cdb-xxxxx.tencentcloudapi.com:3306/student_grades?useSSL=true&serverTimezone=Asia/Shanghai
    username: ${DB_USERNAME}
    password: ${DB_PASSWORD}
    driver-class-name: com.mysql.cj.jdbc.Driver
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000

  jpa:
    hibernate:
      ddl-auto: validate
    show-sql: false
    properties:
      hibernate:
        dialect: org.hibernate.dialect.MySQL8Dialect
        format_sql: true
```

#### 4.1.2 数据库安全配置

```yaml
# 腾讯云MySQL安全配置
spring:
  datasource:
    url: jdbc:mysql://cdb-xxxxx.tencentcloudapi.com:3306/student_grades?useSSL=true&serverTimezone=Asia/Shanghai&allowPublicKeyRetrieval=true
    username: ${DB_USERNAME}
    password: ${DB_PASSWORD}
```

### 4.2 腾讯云COS文件存储集成

#### 4.2.1 COS配置类

```java
@Configuration
@EnableConfigurationProperties(COSProperties.class)
public class COSConfig {
    
    @Bean
    public COSClient cosClient() {
        COSCredentials cred = new BasicCOSCredentials(
            cosProperties.getSecretId(), 
            cosProperties.getSecretKey()
        );
        
        Region region = new Region(cosProperties.getRegion());
        ClientConfig clientConfig = new ClientConfig(region);
        
        return new COSClient(cred, clientConfig);
    }
    
    @Bean
    public COSService cosService(COSClient cosClient, COSProperties cosProperties) {
        return new COSService(cosClient, cosProperties);
    }
}
```

#### 4.2.2 COS服务实现

```java
@Service
public class COSService {
    
    private final COSClient cosClient;
    private final COSProperties cosProperties;
    
    public String uploadFile(MultipartFile file, String folder) {
        String fileName = generateFileName(file.getOriginalFilename());
        String key = folder + "/" + fileName;
        
        try {
            ObjectMetadata metadata = new ObjectMetadata();
            metadata.setContentLength(file.getSize());
            metadata.setContentType(file.getContentType());
            
            PutObjectRequest putObjectRequest = new PutObjectRequest(
                cosProperties.getBucketName(), 
                key, 
                file.getInputStream(), 
                metadata
            );
            
            cosClient.putObject(putObjectRequest);
            return cosProperties.getBaseUrl() + "/" + key;
            
        } catch (IOException e) {
            throw new RuntimeException("文件上传失败", e);
        }
    }
    
    public void deleteFile(String key) {
        cosClient.deleteObject(cosProperties.getBucketName(), key);
    }
}
```

### 4.3 腾讯云Redis集成

#### 4.3.1 Redis配置

```yaml
spring:
  redis:
    host: redis-xxxxx.tencentcloudapi.com
    port: 6379
    password: ${REDIS_PASSWORD}
    timeout: 2000ms
    lettuce:
      pool:
        max-active: 20
        max-idle: 10
        min-idle: 5
```

#### 4.3.2 Redis缓存服务

```java
@Service
public class CacheService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    public void setCache(String key, Object value, Duration duration) {
        redisTemplate.opsForValue().set(key, value, duration);
    }
    
    public Object getCache(String key) {
        return redisTemplate.opsForValue().get(key);
    }
    
    public void deleteCache(String key) {
        redisTemplate.delete(key);
    }
}
```

### 4.4 腾讯云监控集成

#### 4.4.1 自定义指标

```java
@Component
public class TencentCloudMetrics {
    
    @Autowired
    private CloudWatchClient cloudWatchClient;
    
    public void putMetric(String metricName, double value, String unit) {
        PutMetricDataRequest request = PutMetricDataRequest.builder()
                .namespace("StudentGrades/Application")
                .metricData(MetricDatum.builder()
                        .metricName(metricName)
                        .value(value)
                        .unit(unit)
                        .timestamp(Instant.now())
                        .build())
                .build();
        
        cloudWatchClient.putMetricData(request);
    }
}
```

#### 4.4.2 应用监控配置

```yaml
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics
  endpoint:
    health:
      show-details: always
  metrics:
    export:
      prometheus:
        enabled: true
```

## 5. 部署架构

### 5.1 基础设施即代码 (Terraform)

#### 5.1.1 VPC配置

```hcl
resource "tencentcloud_vpc" "student_grades_vpc" {
  name       = "student-grades-vpc"
  cidr_block = "10.0.0.0/16"
  
  tags = {
    Name = "student-grades-vpc"
  }
}

resource "tencentcloud_internet_gateway" "student_grades_igw" {
  name = "student-grades-igw"
  vpc_id = tencentcloud_vpc.student_grades_vpc.id
  
  tags = {
    Name = "student-grades-igw"
  }
}
```

#### 5.1.2 腾讯云MySQL配置

```hcl
resource "tencentcloud_mysql_instance" "student_grades_db" {
  name = "student-grades-db"
  mem_size = 1000
  volume_size = 100
  engine_version = "8.0"
  root_password = var.db_password
  availability_zone = "ap-beijing-1"
  
  vpc_id = tencentcloud_vpc.student_grades_vpc.id
  subnet_id = tencentcloud_subnet.private_subnet.id
  
  tags = {
    Name = "student-grades-db"
  }
}
```

#### 5.1.3 腾讯云Redis配置

```hcl
resource "tencentcloud_redis_instance" "student_grades_redis" {
  name = "student-grades-redis"
  type = "master_slave_redis"
  mem_size = 1024
  port = 6379
  password = var.redis_password
  
  vpc_id = tencentcloud_vpc.student_grades_vpc.id
  subnet_id = tencentcloud_subnet.private_subnet.id
  
  tags = {
    Name = "student-grades-redis"
  }
}
```

### 5.2 Docker容器化部署

#### 5.2.1 前端Dockerfile

```dockerfile
# 构建阶段
FROM node:18-alpine AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production
COPY . .
RUN npm run build

# 生产阶段
FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/nginx.conf
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

#### 5.2.2 后端Dockerfile

```dockerfile
FROM openjdk:17-jre-slim
WORKDIR /app
COPY target/student-grades-*.jar app.jar
EXPOSE 8080
ENTRYPOINT ["java", "-jar", "app.jar"]
```

#### 5.2.3 Docker Compose配置

```yaml
version: '3.8'
services:
  frontend:
    build: ./frontend
    ports:
      - "80:80"
    environment:
      - REACT_APP_API_URL=http://backend:8080
    depends_on:
      - backend
  
  backend:
    build: ./backend
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - DB_HOST=cdb-xxxxx.tencentcloudapi.com
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
      - REDIS_HOST=redis-xxxxx.tencentcloudapi.com
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - COS_BUCKET_NAME=${COS_BUCKET_NAME}
    depends_on:
      - redis
  
  redis:
    image: redis:6-alpine
    ports:
      - "6379:6379"
```

## 6. 安全配置

### 6.1 CAM角色和策略

#### 6.1.1 CVM实例角色

```json
{
  "version": "2.0",
  "statement": [
    {
      "effect": "allow",
      "action": [
        "cos:GetObject",
        "cos:PutObject",
        "cos:DeleteObject"
      ],
      "resource": "qcs::cos:ap-beijing:uid/1234567890:student-grades-files/*"
    },
    {
      "effect": "allow",
      "action": [
        "monitor:PutMetricData"
      ],
      "resource": "*"
    }
  ]
}
```

#### 6.1.2 数据库安全组

```hcl
resource "tencentcloud_security_group" "mysql_sg" {
  name = "student-grades-mysql-sg"
  description = "MySQL security group"
  
  ingress {
    protocol = "TCP"
    port = "3306"
    cidr_block = "10.0.0.0/16"
  }
  
  egress {
    protocol = "TCP"
    port = "ALL"
    cidr_block = "0.0.0.0/0"
  }
}
```

### 6.2 WAF配置

```hcl
resource "tencentcloud_waf_rule" "student_grades_waf" {
  name = "student-grades-waf"
  domain = "student-grades.example.com"
  
  rule {
    name = "RateLimitRule"
    action = "block"
    rate_limit = 2000
  }
}
```

## 7. 监控和告警

### 7.1 腾讯云监控告警

```hcl
resource "tencentcloud_monitor_alarm_policy" "high_cpu" {
  policy_name = "student-grades-high-cpu"
  policy_type = "cvm"
  
  conditions {
    metric_name = "CpuUsage"
    operator = "gt"
    threshold = 80
    period = 300
    count = 2
  }
  
  trigger_tasks {
    type = "AS"
    task_config = jsonencode({
      "asGroupId" = tencentcloud_as_scaling_group.student_grades_as.id
      "scaleOutNum" = 1
    })
  }
}
```

### 7.2 日志配置

```yaml
# Logback配置
logging:
  level:
    com.studentgrades: INFO
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
  file:
    name: /var/log/student-grades/application.log
```

## 8. 成本优化策略

### 8.1 资源优化

- **CVM实例**: 使用按量计费实例，支持自动扩缩容
- **MySQL**: 使用基础版，按需升级
- **COS**: 使用标准存储，配置生命周期规则
- **CDN**: 配置缓存策略减少源站请求

### 8.2 成本监控

```hcl
resource "tencentcloud_monitor_alarm_policy" "cost_alarm" {
  policy_name = "student-grades-cost-alarm"
  policy_type = "billing"
  
  conditions {
    metric_name = "TotalCost"
    operator = "gt"
    threshold = 100
    period = 86400
    count = 1
  }
}
```

## 9. 灾难恢复

### 9.1 备份策略

- **MySQL**: 自动备份7天，支持时间点恢复
- **COS**: 跨地域复制
- **应用**: 定期创建镜像快照

### 9.2 恢复流程

1. 启动备用地域资源
2. 恢复数据库到最新状态
3. 更新DNS指向备用地域
4. 验证系统功能正常

## 10. 性能优化

### 10.1 数据库优化

- 启用连接池
- 配置读写分离
- 使用查询缓存

### 10.2 应用优化

- 启用Gzip压缩
- 配置静态资源缓存
- 使用CDN加速

### 10.3 监控指标

- 响应时间 < 200ms
- 可用性 > 99.9%
- 并发用户 > 1000

## 11. 腾讯云特有功能

### 11.1 弹性伸缩

```hcl
resource "tencentcloud_as_scaling_group" "student_grades_as" {
  scaling_group_name = "student-grades-as"
  max_size = 10
  min_size = 2
  desired_capacity = 3
  
  vpc_id = tencentcloud_vpc.student_grades_vpc.id
  subnet_ids = [
    tencentcloud_subnet.private_subnet_1.id,
    tencentcloud_subnet.private_subnet_2.id
  ]
}
```

### 11.2 负载均衡

```hcl
resource "tencentcloud_clb_instance" "student_grades_clb" {
  clb_name = "student-grades-clb"
  network_type = "OPEN"
  clb_vips = ["student-grades.example.com"]
}
```

### 11.3 CDN加速

```hcl
resource "tencentcloud_cdn_domain" "student_grades_cdn" {
  domain = "student-grades.example.com"
  service_type = "web"
  origin {
    origin_type = "ip"
    origin_list = ["1.2.3.4"]
  }
}
```

## 12. 部署脚本

### 12.1 自动化部署脚本

```bash
#!/bin/bash
# 部署脚本

# 1. 构建应用
echo "构建前端应用..."
cd frontend
npm install
npm run build

echo "构建后端应用..."
cd ../backend
mvn clean package

# 2. 构建Docker镜像
echo "构建Docker镜像..."
docker build -t student-grades-frontend ./frontend
docker build -t student-grades-backend ./backend

# 3. 推送到腾讯云容器镜像服务
echo "推送镜像到腾讯云..."
docker tag student-grades-frontend ccr.ccs.tencentyun.com/student-grades/frontend:latest
docker tag student-grades-backend ccr.ccs.tencentyun.com/student-grades/backend:latest

docker push ccr.ccs.tencentyun.com/student-grades/frontend:latest
docker push ccr.ccs.tencentyun.com/student-grades/backend:latest

# 4. 部署到CVM
echo "部署到CVM..."
ssh root@your-server-ip "docker pull ccr.ccs.tencentyun.com/student-grades/frontend:latest"
ssh root@your-server-ip "docker pull ccr.ccs.tencentyun.com/student-grades/backend:latest"
ssh root@your-server-ip "docker-compose up -d"
```

## 13. 监控面板

### 13.1 关键指标监控

- **系统指标**: CPU使用率、内存使用率、磁盘使用率
- **应用指标**: 响应时间、吞吐量、错误率
- **数据库指标**: 连接数、查询时间、锁等待
- **业务指标**: 用户数、成绩查询次数、文件上传次数

### 13.2 告警规则

- CPU使用率 > 80% 持续5分钟
- 内存使用率 > 90% 持续5分钟
- 响应时间 > 2秒 持续3分钟
- 错误率 > 5% 持续2分钟
