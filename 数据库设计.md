# 学生成绩查询系统 - 数据库设计

## 1. 数据库概述

本系统使用MySQL作为主数据库，设计遵循第三范式，确保数据一致性和完整性。数据库设计支持用户管理、学生信息管理、成绩管理、时间段控制等核心功能。

## 2. 数据库表结构设计

### 2.1 用户表 (users)

```sql
CREATE TABLE users (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    role ENUM('STUDENT', 'TEACHER', 'ADMIN') NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    last_login TIMESTAMP NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_role ON users(role);
```

### 2.2 学生表 (students)

```sql
CREATE TABLE students (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT UNIQUE NOT NULL,
    student_id VARCHAR(20) UNIQUE NOT NULL,
    name VARCHAR(100) NOT NULL,
    class_name VARCHAR(50),
    major VARCHAR(100),
    enrollment_date DATE,
    graduation_date DATE,
    status ENUM('ACTIVE', 'GRADUATED', 'SUSPENDED') DEFAULT 'ACTIVE',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

-- 索引
CREATE INDEX idx_students_student_id ON students(student_id);
CREATE INDEX idx_students_user_id ON students(user_id);
CREATE INDEX idx_students_class_name ON students(class_name);
CREATE INDEX idx_students_status ON students(status);
```

### 2.3 教师表 (teachers)

```sql
CREATE TABLE teachers (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT UNIQUE NOT NULL,
    teacher_id VARCHAR(20) UNIQUE NOT NULL,
    name VARCHAR(100) NOT NULL,
    department VARCHAR(100),
    title VARCHAR(50),
    phone VARCHAR(20),
    office VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

-- 索引
CREATE INDEX idx_teachers_teacher_id ON teachers(teacher_id);
CREATE INDEX idx_teachers_user_id ON teachers(user_id);
CREATE INDEX idx_teachers_department ON teachers(department);
```

### 2.4 课程表 (courses)

```sql
CREATE TABLE courses (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    course_code VARCHAR(20) UNIQUE NOT NULL,
    course_name VARCHAR(200) NOT NULL,
    credits INTEGER NOT NULL,
    department VARCHAR(100),
    description TEXT,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    CHECK (credits > 0)
);

-- 索引
CREATE INDEX idx_courses_course_code ON courses(course_code);
CREATE INDEX idx_courses_department ON courses(department);
CREATE INDEX idx_courses_is_active ON courses(is_active);
```

### 2.5 成绩表 (grades)

```sql
CREATE TABLE grades (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    student_id BIGINT NOT NULL,
    course_id BIGINT NOT NULL,
    teacher_id BIGINT NOT NULL,
    semester VARCHAR(20) NOT NULL,
    academic_year VARCHAR(10) NOT NULL,
    score DECIMAL(5,2),
    grade_letter VARCHAR(2),
    is_passed BOOLEAN DEFAULT FALSE,
    exam_type ENUM('MIDTERM', 'FINAL', 'ASSIGNMENT', 'PROJECT') DEFAULT 'FINAL',
    remarks TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (student_id) REFERENCES students(id) ON DELETE CASCADE,
    FOREIGN KEY (course_id) REFERENCES courses(id) ON DELETE CASCADE,
    FOREIGN KEY (teacher_id) REFERENCES teachers(id) ON DELETE CASCADE,
    UNIQUE(student_id, course_id, semester, academic_year),
    CHECK (score >= 0 AND score <= 100)
);

-- 索引
CREATE INDEX idx_grades_student_id ON grades(student_id);
CREATE INDEX idx_grades_course_id ON grades(course_id);
CREATE INDEX idx_grades_teacher_id ON grades(teacher_id);
CREATE INDEX idx_grades_semester ON grades(semester);
CREATE INDEX idx_grades_academic_year ON grades(academic_year);
CREATE INDEX idx_grades_score ON grades(score);
```

### 2.6 时间段控制表 (time_periods)

```sql
CREATE TABLE time_periods (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    start_date TIMESTAMP NOT NULL,
    end_date TIMESTAMP NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    created_by BIGINT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (created_by) REFERENCES users(id),
    CHECK (end_date > start_date)
);

-- 索引
CREATE INDEX idx_time_periods_start_date ON time_periods(start_date);
CREATE INDEX idx_time_periods_end_date ON time_periods(end_date);
CREATE INDEX idx_time_periods_is_active ON time_periods(is_active);
CREATE INDEX idx_time_periods_created_by ON time_periods(created_by);
```

### 2.7 文件上传记录表 (file_uploads)

```sql
CREATE TABLE file_uploads (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    filename VARCHAR(255) NOT NULL,
    original_filename VARCHAR(255) NOT NULL,
    file_path VARCHAR(500) NOT NULL,
    file_size BIGINT NOT NULL,
    file_type VARCHAR(50) NOT NULL,
    upload_type ENUM('GRADES', 'STUDENTS', 'COURSES') NOT NULL,
    status ENUM('PENDING', 'PROCESSING', 'SUCCESS', 'FAILED') DEFAULT 'PENDING',
    total_records INTEGER DEFAULT 0,
    success_records INTEGER DEFAULT 0,
    failed_records INTEGER DEFAULT 0,
    error_message TEXT,
    uploaded_by BIGINT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (uploaded_by) REFERENCES users(id)
);

-- 索引
CREATE INDEX idx_file_uploads_uploaded_by ON file_uploads(uploaded_by);
CREATE INDEX idx_file_uploads_status ON file_uploads(status);
CREATE INDEX idx_file_uploads_upload_type ON file_uploads(upload_type);
CREATE INDEX idx_file_uploads_created_at ON file_uploads(created_at);
```

### 2.8 系统配置表 (system_configs)

```sql
CREATE TABLE system_configs (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    config_key VARCHAR(100) UNIQUE NOT NULL,
    config_value TEXT,
    description TEXT,
    config_type ENUM('STRING', 'NUMBER', 'BOOLEAN', 'JSON') DEFAULT 'STRING',
    is_public BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_system_configs_config_key ON system_configs(config_key);
CREATE INDEX idx_system_configs_is_public ON system_configs(is_public);
```

### 2.9 操作日志表 (operation_logs)

```sql
CREATE TABLE operation_logs (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT,
    operation_type VARCHAR(50) NOT NULL,
    operation_description TEXT,
    target_table VARCHAR(50),
    target_id BIGINT,
    old_values JSON,
    new_values JSON,
    ip_address VARCHAR(45),
    user_agent TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);

-- 索引
CREATE INDEX idx_operation_logs_user_id ON operation_logs(user_id);
CREATE INDEX idx_operation_logs_operation_type ON operation_logs(operation_type);
CREATE INDEX idx_operation_logs_target_table ON operation_logs(target_table);
CREATE INDEX idx_operation_logs_created_at ON operation_logs(created_at);
```

## 3. 数据库关系图

```
users (1) ←→ (1) students
users (1) ←→ (1) teachers
students (1) ←→ (*) grades
courses (1) ←→ (*) grades
teachers (1) ←→ (*) grades
users (1) ←→ (*) time_periods
users (1) ←→ (*) file_uploads
users (1) ←→ (*) operation_logs
```

## 4. 数据库约束和规则

### 4.1 外键约束
- 所有外键都设置了适当的级联删除规则
- 学生、教师与用户表是一对一关系
- 成绩表与多个表建立多对一关系

### 4.2 检查约束
- 用户角色只能是STUDENT、TEACHER、ADMIN
- 学生状态只能是ACTIVE、GRADUATED、SUSPENDED
- 成绩分数范围0-100
- 时间段结束时间必须大于开始时间

### 4.3 唯一约束
- 用户名、邮箱、学号、教师编号、课程代码必须唯一
- 学生同一课程同一学期只能有一条成绩记录

## 5. 数据库索引策略

### 5.1 主键索引
- 所有表都有自增主键，自动创建主键索引

### 5.2 唯一索引
- 用户名、邮箱、学号等唯一字段创建唯一索引

### 5.3 普通索引
- 外键字段创建索引提高关联查询性能
- 常用查询字段创建索引
- 时间字段创建索引支持时间范围查询

### 5.4 复合索引
```sql
-- 成绩查询复合索引
CREATE INDEX idx_grades_student_semester ON grades(student_id, semester);
CREATE INDEX idx_grades_course_semester ON grades(course_id, semester);

-- 时间段查询复合索引
CREATE INDEX idx_time_periods_active_dates ON time_periods(is_active, start_date, end_date);
```

## 6. 数据库触发器

### 6.1 更新时间戳触发器
```sql
-- MySQL使用ON UPDATE CURRENT_TIMESTAMP自动更新updated_at字段
-- 在表定义中已经包含了ON UPDATE CURRENT_TIMESTAMP
-- 无需额外的触发器
```

### 6.2 成绩等级自动计算触发器
```sql
DELIMITER $$

CREATE TRIGGER calculate_grade_letter_trigger 
BEFORE INSERT ON grades
FOR EACH ROW
BEGIN
    -- 根据分数自动计算等级
    IF NEW.score >= 90 THEN
        SET NEW.grade_letter = 'A', NEW.is_passed = TRUE;
    ELSEIF NEW.score >= 80 THEN
        SET NEW.grade_letter = 'B', NEW.is_passed = TRUE;
    ELSEIF NEW.score >= 70 THEN
        SET NEW.grade_letter = 'C', NEW.is_passed = TRUE;
    ELSEIF NEW.score >= 60 THEN
        SET NEW.grade_letter = 'D', NEW.is_passed = TRUE;
    ELSE
        SET NEW.grade_letter = 'F', NEW.is_passed = FALSE;
    END IF;
END$$

CREATE TRIGGER calculate_grade_letter_trigger_update 
BEFORE UPDATE ON grades
FOR EACH ROW
BEGIN
    -- 根据分数自动计算等级
    IF NEW.score >= 90 THEN
        SET NEW.grade_letter = 'A', NEW.is_passed = TRUE;
    ELSEIF NEW.score >= 80 THEN
        SET NEW.grade_letter = 'B', NEW.is_passed = TRUE;
    ELSEIF NEW.score >= 70 THEN
        SET NEW.grade_letter = 'C', NEW.is_passed = TRUE;
    ELSEIF NEW.score >= 60 THEN
        SET NEW.grade_letter = 'D', NEW.is_passed = TRUE;
    ELSE
        SET NEW.grade_letter = 'F', NEW.is_passed = FALSE;
    END IF;
END$$

DELIMITER ;
```

## 7. 数据库视图

### 7.1 学生成绩详情视图
```sql
CREATE VIEW student_grade_details AS
SELECT 
    s.student_id,
    s.name as student_name,
    s.class_name,
    c.course_code,
    c.course_name,
    c.credits,
    g.semester,
    g.academic_year,
    g.score,
    g.grade_letter,
    g.is_passed,
    t.name as teacher_name,
    g.created_at
FROM students s
JOIN grades g ON s.id = g.student_id
JOIN courses c ON g.course_id = c.id
JOIN teachers t ON g.teacher_id = t.id;
```

### 7.2 活跃时间段视图
```sql
CREATE VIEW active_time_periods AS
SELECT 
    tp.*,
    u.username as created_by_username
FROM time_periods tp
JOIN users u ON tp.created_by = u.id
WHERE tp.is_active = TRUE 
AND tp.start_date <= CURRENT_TIMESTAMP 
AND tp.end_date >= CURRENT_TIMESTAMP;
```

## 8. 数据库存储过程

### 8.1 批量导入成绩存储过程
```sql
DELIMITER $$

CREATE PROCEDURE import_grades_batch(
    IN p_student_ids JSON,
    IN p_course_ids JSON,
    IN p_scores JSON,
    IN p_semester VARCHAR(20),
    IN p_academic_year VARCHAR(10),
    IN p_teacher_id BIGINT,
    OUT success_count INT
)
BEGIN
    DECLARE i INT DEFAULT 0;
    DECLARE student_count INT;
    DECLARE student_id VARCHAR(20);
    DECLARE course_id BIGINT;
    DECLARE score DECIMAL(5,2);
    
    SET success_count = 0;
    SET student_count = JSON_LENGTH(p_student_ids);
    
    WHILE i < student_count DO
        SET student_id = JSON_UNQUOTE(JSON_EXTRACT(p_student_ids, CONCAT('$[', i, ']')));
        SET course_id = JSON_UNQUOTE(JSON_EXTRACT(p_course_ids, CONCAT('$[', i, ']')));
        SET score = JSON_UNQUOTE(JSON_EXTRACT(p_scores, CONCAT('$[', i, ']')));
        
        BEGIN
            DECLARE CONTINUE HANDLER FOR SQLEXCEPTION
            BEGIN
                -- 记录错误但继续处理
            END;
            
            INSERT INTO grades (student_id, course_id, teacher_id, semester, academic_year, score)
            VALUES (
                (SELECT id FROM students WHERE student_id = student_id),
                course_id,
                p_teacher_id,
                p_semester,
                p_academic_year,
                score
            );
            
            SET success_count = success_count + 1;
        END;
        
        SET i = i + 1;
    END WHILE;
END$$

DELIMITER ;
```

## 9. 数据库备份和恢复策略

### 9.1 备份策略
- 每日全量备份
- 每小时增量备份
- 重要操作前手动备份

### 9.2 恢复策略
- 支持时间点恢复
- 支持表级恢复
- 支持数据迁移

## 10. 数据库性能优化

### 10.1 查询优化
- 使用适当的索引
- 避免全表扫描
- 优化JOIN查询
- 使用EXPLAIN分析查询计划

### 10.2 连接池配置
- 最大连接数：100
- 最小连接数：10
- 连接超时：30秒
- 空闲超时：60秒

### 10.3 缓存策略
- 使用Redis缓存热点数据
- 缓存用户会话信息
- 缓存查询结果
