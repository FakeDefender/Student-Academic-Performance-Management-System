# 学生成绩查询系统 - 数据库设计

## 1. 数据库概述

本系统使用MySQL 8.0作为主数据库，设计遵循第三范式，确保数据一致性和完整性。数据库设计支持用户管理、学生信息管理、成绩管理、时间段控制等核心功能。采用逻辑外键策略，不使用物理外键约束，由服务层进行数据一致性校验。

## 2. 数据库表结构设计

### 2.1 用户表 (users)

```sql
CREATE TABLE IF NOT EXISTS users (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  username VARCHAR(50) NOT NULL UNIQUE,
  password VARCHAR(255) NOT NULL,
  email VARCHAR(100) NOT NULL UNIQUE,
  role ENUM('STUDENT','TEACHER','ADMIN') NOT NULL,
  is_active BOOLEAN DEFAULT TRUE,
  last_login TIMESTAMP NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 索引
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_role ON users(role);
```

**字段说明：**
- `id`: 主键，自增长
- `username`: 用户名，唯一
- `password`: 密码，加密存储
- `email`: 邮箱，唯一
- `role`: 用户角色（学生/教师/管理员）
- `is_active`: 是否激活
- `last_login`: 最后登录时间
- `created_at`: 创建时间
- `updated_at`: 更新时间

### 2.2 学生表 (students)

```sql
CREATE TABLE IF NOT EXISTS students (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  user_id BIGINT NOT NULL UNIQUE,
  student_id VARCHAR(20) NOT NULL UNIQUE,
  name VARCHAR(100) NOT NULL,
  class_name VARCHAR(50),
  major VARCHAR(100),
  enrollment_date DATE,
  graduation_date DATE,
  status ENUM('ACTIVE','GRADUATED','SUSPENDED') DEFAULT 'ACTIVE',
  email VARCHAR(100) COMMENT '邮箱',
  phone VARCHAR(20) COMMENT '电话',
  address TEXT COMMENT '地址',
  remarks TEXT COMMENT '备注',
  grade VARCHAR(20) COMMENT '年级',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 索引
CREATE INDEX idx_students_student_id ON students(student_id);
CREATE INDEX idx_students_user_id ON students(user_id);
CREATE INDEX idx_students_class_name ON students(class_name);
CREATE INDEX idx_students_status ON students(status);
```

**字段说明：**
- `id`: 主键，自增长
- `user_id`: 关联用户表ID
- `student_id`: 学号，唯一
- `name`: 学生姓名
- `class_name`: 班级名称
- `major`: 专业
- `enrollment_date`: 入学日期
- `graduation_date`: 毕业日期
- `status`: 学生状态
- `email`: 邮箱
- `phone`: 电话
- `address`: 地址
- `remarks`: 备注
- `grade`: 年级

### 2.3 教师表 (teachers)

```sql
CREATE TABLE IF NOT EXISTS teachers (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  user_id BIGINT NOT NULL UNIQUE,
  teacher_id VARCHAR(20) NOT NULL UNIQUE,
  name VARCHAR(100) NOT NULL,
  department VARCHAR(100),
  title VARCHAR(50),
  phone VARCHAR(20),
  office VARCHAR(100),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 索引
CREATE INDEX idx_teachers_teacher_id ON teachers(teacher_id);
CREATE INDEX idx_teachers_user_id ON teachers(user_id);
CREATE INDEX idx_teachers_department ON teachers(department);
```

**字段说明：**
- `id`: 主键，自增长
- `user_id`: 关联用户表ID
- `teacher_id`: 教师编号，唯一
- `name`: 教师姓名
- `department`: 部门
- `title`: 职称
- `phone`: 电话
- `office`: 办公室

### 2.4 课程表 (courses)

```sql
CREATE TABLE IF NOT EXISTS courses (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  course_code VARCHAR(20) NOT NULL UNIQUE,
  course_name VARCHAR(200) NOT NULL,
  credits INT NOT NULL,
  department VARCHAR(100),
  description TEXT,
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  CHECK (credits > 0)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 索引
CREATE INDEX idx_courses_course_code ON courses(course_code);
CREATE INDEX idx_courses_department ON courses(department);
CREATE INDEX idx_courses_is_active ON courses(is_active);
```

**字段说明：**
- `id`: 主键，自增长
- `course_code`: 课程代码，唯一
- `course_name`: 课程名称
- `credits`: 学分
- `department`: 开课部门
- `description`: 课程描述
- `is_active`: 是否激活

### 2.5 成绩表 (grades)

```sql
CREATE TABLE IF NOT EXISTS grades (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  student_id BIGINT NOT NULL,
  course_id BIGINT NOT NULL,
  teacher_id BIGINT NOT NULL,
  semester VARCHAR(20) NOT NULL,
  academic_year VARCHAR(10) NOT NULL,
  score DECIMAL(5,2),
  grade_letter VARCHAR(2),
  is_passed BOOLEAN DEFAULT FALSE,
  exam_type ENUM('MIDTERM','FINAL','ASSIGNMENT','PROJECT') DEFAULT 'FINAL',
  remarks TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY uk_grades (student_id, course_id, semester, academic_year),
  CHECK (score IS NULL OR (score >= 0 AND score <= 100))
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 索引
CREATE INDEX idx_grades_student_id ON grades(student_id);
CREATE INDEX idx_grades_course_id ON grades(course_id);
CREATE INDEX idx_grades_teacher_id ON grades(teacher_id);
CREATE INDEX idx_grades_semester ON grades(semester);
CREATE INDEX idx_grades_academic_year ON grades(academic_year);
CREATE INDEX idx_grades_score ON grades(score);
```

**字段说明：**
- `id`: 主键，自增长
- `student_id`: 学生ID
- `course_id`: 课程ID
- `teacher_id`: 教师ID
- `semester`: 学期
- `academic_year`: 学年
- `score`: 分数（0-100）
- `grade_letter`: 等级（A/B/C/D/F）
- `is_passed`: 是否通过
- `exam_type`: 考试类型
- `remarks`: 备注

### 2.6 时间段控制表 (time_periods)

```sql
CREATE TABLE IF NOT EXISTS time_periods (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  description TEXT,
  start_date TIMESTAMP NOT NULL,
  end_date TIMESTAMP NOT NULL,
  is_active BOOLEAN DEFAULT TRUE,
  created_by BIGINT NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  CHECK (end_date > start_date)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 索引
CREATE INDEX idx_time_periods_start_date ON time_periods(start_date);
CREATE INDEX idx_time_periods_end_date ON time_periods(end_date);
CREATE INDEX idx_time_periods_is_active ON time_periods(is_active);
CREATE INDEX idx_time_periods_created_by ON time_periods(created_by);
```

**字段说明：**
- `id`: 主键，自增长
- `name`: 时间段名称
- `description`: 描述
- `start_date`: 开始时间
- `end_date`: 结束时间
- `is_active`: 是否激活
- `created_by`: 创建者ID

### 2.7 教师课程关联表 (teacher_courses)

```sql
CREATE TABLE teacher_courses (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    teacher_id BIGINT NOT NULL,
    course_id BIGINT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_teacher_course (teacher_id, course_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

**字段说明：**
- `id`: 主键，自增长
- `teacher_id`: 教师ID
- `course_id`: 课程ID
- 唯一约束：同一教师不能重复教授同一课程

### 2.8 课程时间段关联表 (course_time_periods)

```sql
CREATE TABLE course_time_periods (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    course_id BIGINT NOT NULL,
    time_period_id BIGINT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_course_time_period (course_id, time_period_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

**字段说明：**
- `id`: 主键，自增长
- `course_id`: 课程ID
- `time_period_id`: 时间段ID
- 唯一约束：同一课程不能重复关联同一时间段

### 2.9 文件上传记录表 (file_uploads)

```sql
CREATE TABLE IF NOT EXISTS file_uploads (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  filename VARCHAR(255) NOT NULL,
  original_filename VARCHAR(255) NOT NULL,
  file_path VARCHAR(500) NOT NULL,
  file_size BIGINT NOT NULL,
  file_type VARCHAR(50) NOT NULL,
  upload_type ENUM('GRADES','STUDENTS','COURSES') NOT NULL,
  status ENUM('PENDING','PROCESSING','SUCCESS','FAILED') DEFAULT 'PENDING',
  total_records INT DEFAULT 0,
  success_records INT DEFAULT 0,
  failed_records INT DEFAULT 0,
  error_message TEXT,
  uploaded_by BIGINT NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 索引
CREATE INDEX idx_file_uploads_uploaded_by ON file_uploads(uploaded_by);
CREATE INDEX idx_file_uploads_status ON file_uploads(status);
CREATE INDEX idx_file_uploads_upload_type ON file_uploads(upload_type);
CREATE INDEX idx_file_uploads_created_at ON file_uploads(created_at);
```

**字段说明：**
- `id`: 主键，自增长
- `filename`: 文件名
- `original_filename`: 原始文件名
- `file_path`: 文件路径
- `file_size`: 文件大小
- `file_type`: 文件类型
- `upload_type`: 上传类型
- `status`: 处理状态
- `total_records`: 总记录数
- `success_records`: 成功记录数
- `failed_records`: 失败记录数
- `error_message`: 错误信息
- `uploaded_by`: 上传者ID

### 2.10 系统配置表 (system_configs)

```sql
CREATE TABLE IF NOT EXISTS system_configs (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  config_key VARCHAR(100) NOT NULL UNIQUE,
  config_value TEXT,
  description TEXT,
  config_type ENUM('STRING','NUMBER','BOOLEAN','JSON') DEFAULT 'STRING',
  is_public BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 索引
CREATE INDEX idx_system_configs_is_public ON system_configs(is_public);
```

**字段说明：**
- `id`: 主键，自增长
- `config_key`: 配置键，唯一
- `config_value`: 配置值
- `description`: 描述
- `config_type`: 配置类型
- `is_public`: 是否公开

### 2.11 操作日志表 (operation_logs)

```sql
CREATE TABLE IF NOT EXISTS operation_logs (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  user_id BIGINT,
  operation_type VARCHAR(50) NOT NULL,
  operation_description TEXT,
  target_table VARCHAR(50),
  target_id BIGINT,
  old_values JSON,
  new_values JSON,
  ip_address VARCHAR(45),
  user_agent TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 索引
CREATE INDEX idx_operation_logs_user_id ON operation_logs(user_id);
CREATE INDEX idx_operation_logs_operation_type ON operation_logs(operation_type);
CREATE INDEX idx_operation_logs_target_table ON operation_logs(target_table);
CREATE INDEX idx_operation_logs_created_at ON operation_logs(created_at);
```

**字段说明：**
- `id`: 主键，自增长
- `user_id`: 操作用户ID
- `operation_type`: 操作类型
- `operation_description`: 操作描述
- `target_table`: 目标表
- `target_id`: 目标记录ID
- `old_values`: 旧值（JSON格式）
- `new_values`: 新值（JSON格式）
- `ip_address`: IP地址
- `user_agent`: 用户代理

## 3. 数据库关系图

```
users (1) ←→ (1) students
users (1) ←→ (1) teachers
students (1) ←→ (*) grades
courses (1) ←→ (*) grades
teachers (1) ←→ (*) grades
teachers (*) ←→ (*) courses (通过teacher_courses表)
courses (*) ←→ (*) time_periods (通过course_time_periods表)
users (1) ←→ (*) time_periods
users (1) ←→ (*) file_uploads
users (1) ←→ (*) operation_logs
```

## 4. 数据库约束和规则

### 4.1 外键约束（逻辑外键策略）
- 不创建任何物理外键约束（FOREIGN KEY）
- 所有跨表关联由服务层进行存在性校验（如用户、学生、课程、教师是否存在）
- 删除保护：对被引用实体执行删除时，服务层先检查是否被其他记录引用，必要时执行软删除或阻止删除
- 通过唯一键与索引保证可引用性与查询性能

### 4.2 一致性保障
- 写入前：在服务层进行强校验（存在性校验、状态校验）
- 写入后：提供定时一致性审计任务，扫描并记录"孤儿记录"（如 grades.student_id 不存在于 students）
- 恢复措施：提供审计报表与修复脚本（清理或补齐）
- 事务策略：在同一业务事务内先写主表再写子表，避免中间状态

### 4.3 关系解释
- 本文档中的"关系图"为逻辑关系，仅用于说明业务约束，不代表物理外键

### 4.4 检查约束
- 用户角色只能是STUDENT、TEACHER、ADMIN
- 学生状态只能是ACTIVE、GRADUATED、SUSPENDED
- 成绩分数范围0-100
- 时间段结束时间必须大于开始时间
- 课程学分必须大于0

### 4.5 唯一约束
- 用户名、邮箱、学号、教师编号、课程代码必须唯一
- 学生同一课程同一学期只能有一条成绩记录
- 教师课程关联唯一
- 课程时间段关联唯一

## 5. 数据库索引策略

### 5.1 主键索引
- 所有表都有自增主键，自动创建主键索引

### 5.2 唯一索引
- 用户名、邮箱、学号、教师编号、课程代码等唯一字段创建唯一索引

### 5.3 普通索引
- 外键字段创建索引提高关联查询性能
- 常用查询字段创建索引
- 时间字段创建索引支持时间范围查询

### 5.4 复合索引
```sql
-- 成绩查询复合索引
CREATE INDEX idx_grades_student_semester ON grades(student_id, semester);
CREATE INDEX idx_grades_course_semester ON grades(course_id, semester);

-- 时间段查询复合索引
CREATE INDEX idx_time_periods_active_dates ON time_periods(is_active, start_date, end_date);
```

## 6. 数据库触发器

### 6.1 成绩等级自动计算触发器
```sql
DELIMITER $$

CREATE TRIGGER trg_grades_before_insert
BEFORE INSERT ON grades
FOR EACH ROW
BEGIN
  IF NEW.score IS NOT NULL THEN
    IF NEW.score >= 90 THEN SET NEW.grade_letter='A', NEW.is_passed=TRUE;
    ELSEIF NEW.score >= 80 THEN SET NEW.grade_letter='B', NEW.is_passed=TRUE;
    ELSEIF NEW.score >= 70 THEN SET NEW.grade_letter='C', NEW.is_passed=TRUE;
    ELSEIF NEW.score >= 60 THEN SET NEW.grade_letter='D', NEW.is_passed=TRUE;
    ELSE SET NEW.grade_letter='F', NEW.is_passed=FALSE; END IF;
  END IF;
END$$

CREATE TRIGGER trg_grades_before_update
BEFORE UPDATE ON grades
FOR EACH ROW
BEGIN
  IF NEW.score IS NOT NULL THEN
    IF NEW.score >= 90 THEN SET NEW.grade_letter='A', NEW.is_passed=TRUE;
    ELSEIF NEW.score >= 80 THEN SET NEW.grade_letter='B', NEW.is_passed=TRUE;
    ELSEIF NEW.score >= 70 THEN SET NEW.grade_letter='C', NEW.is_passed=TRUE;
    ELSEIF NEW.score >= 60 THEN SET NEW.grade_letter='D', NEW.is_passed=TRUE;
    ELSE SET NEW.grade_letter='F', NEW.is_passed=FALSE; END IF;
  END IF;
END$$

DELIMITER ;
```

## 7. 数据库视图

### 7.1 学生成绩详情视图
```sql
CREATE VIEW student_grade_details AS
SELECT 
    s.student_id,
    s.name as student_name,
    s.class_name,
    c.course_code,
    c.course_name,
    c.credits,
    g.semester,
    g.academic_year,
    g.score,
    g.grade_letter,
    g.is_passed,
    t.name as teacher_name,
    g.created_at
FROM students s
JOIN grades g ON s.id = g.student_id
JOIN courses c ON g.course_id = c.id
JOIN teachers t ON g.teacher_id = t.id;
```

### 7.2 活跃时间段视图
```sql
CREATE VIEW active_time_periods AS
SELECT 
    tp.*,
    u.username as created_by_username
FROM time_periods tp
JOIN users u ON tp.created_by = u.id
WHERE tp.is_active = TRUE 
AND tp.start_date <= CURRENT_TIMESTAMP 
AND tp.end_date >= CURRENT_TIMESTAMP;
```

## 8. 数据库存储过程

### 8.1 批量导入成绩存储过程
```sql
DELIMITER $$

CREATE PROCEDURE import_grades_batch(
    IN p_student_ids JSON,
    IN p_course_ids JSON,
    IN p_scores JSON,
    IN p_semester VARCHAR(20),
    IN p_academic_year VARCHAR(10),
    IN p_teacher_id BIGINT,
    OUT success_count INT
)
BEGIN
    DECLARE i INT DEFAULT 0;
    DECLARE student_count INT;
    DECLARE student_id VARCHAR(20);
    DECLARE course_id BIGINT;
    DECLARE score DECIMAL(5,2);
    
    SET success_count = 0;
    SET student_count = JSON_LENGTH(p_student_ids);
    
    WHILE i < student_count DO
        SET student_id = JSON_UNQUOTE(JSON_EXTRACT(p_student_ids, CONCAT('$[', i, ']')));
        SET course_id = JSON_UNQUOTE(JSON_EXTRACT(p_course_ids, CONCAT('$[', i, ']')));
        SET score = JSON_UNQUOTE(JSON_EXTRACT(p_scores, CONCAT('$[', i, ']')));
        
        BEGIN
            DECLARE CONTINUE HANDLER FOR SQLEXCEPTION
            BEGIN
                -- 记录错误但继续处理
            END;
            
            INSERT INTO grades (student_id, course_id, teacher_id, semester, academic_year, score)
            VALUES (
                (SELECT id FROM students WHERE student_id = student_id),
                course_id,
                p_teacher_id,
                p_semester,
                p_academic_year,
                score
            );
            
            SET success_count = success_count + 1;
        END;
        
        SET i = i + 1;
    END WHILE;
END$$

DELIMITER ;
```

## 9. 数据库备份和恢复策略

### 9.1 备份策略
- 每日全量备份
- 每小时增量备份
- 重要操作前手动备份

### 9.2 恢复策略
- 支持时间点恢复
- 支持表级恢复
- 支持数据迁移

## 10. 数据库性能优化

### 10.1 查询优化
- 使用适当的索引
- 避免全表扫描
- 优化JOIN查询
- 使用EXPLAIN分析查询计划

### 10.2 连接池配置
- 最大连接数：100
- 最小连接数：10
- 连接超时：30秒
- 空闲超时：60秒

### 10.3 缓存策略
- 使用Redis缓存热点数据
- 缓存用户会话信息
- 缓存查询结果

## 11. 数据库初始化脚本

### 11.1 创建表结构
- `02-create-tables.sql`: 创建所有数据库表

### 11.2 插入示例数据
- `03-insert-sample-data.sql`: 插入测试数据

### 11.3 关联数据
- `04-teacher-courses.sql`: 教师课程关联数据
- `05-course-time-periods.sql`: 课程时间段数据

### 11.4 表结构更新
- `06-update-students-table.sql`: 更新学生表结构（添加个人信息字段）

## 12. 数据库连接配置

### 12.1 腾讯云MySQL配置
- 主机: 43.139.178.197
- 端口: 13306
- 用户名: root
- 密码: 20030807
- 数据库: student_grades
- 字符集: utf8mb4

### 12.2 连接池配置
```properties
spring.datasource.url=jdbc:mysql://43.139.178.197:13306/student_grades?characterEncoding=utf8mb4&useSSL=false&serverTimezone=Asia/Shanghai
spring.datasource.username=root
spring.datasource.password=20030807
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver
spring.datasource.hikari.maximum-pool-size=20
spring.datasource.hikari.minimum-idle=5
spring.datasource.hikari.connection-timeout=30000
spring.datasource.hikari.idle-timeout=600000
spring.datasource.hikari.max-lifetime=1800000
```

## 13. 数据库监控

### 13.1 性能监控
- 查询执行时间监控
- 慢查询日志
- 连接数监控
- 锁等待监控

### 13.2 空间监控
- 表空间使用情况
- 索引空间使用情况
- 日志文件大小

### 13.3 健康检查
- 数据库连接状态
- 主从复制状态
- 备份任务状态